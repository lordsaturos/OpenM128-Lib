/*********************************************************************
	微 雪 电 子   WaveShare   http://www.waveShare.net            	
		                                                        
目    的:   建立使用AT45DB161的示例程序
	
目标系统:   基于AVR单片机
		                                                                
应用软件:   ICCAVR
		                                                                
版    本:   Version 1.0                                                          
		                                                                
圆版时间:   2005-03-1
	
开发人员:   SEE

说    明:   若用于商业用途，请保留此段文字或注明代码来源
	
	深 圳 市 微 雪 电 子 有 限 公 司 保 留 所 有 的 版 权     
*********************************************************************/

/*01010101010101010101010101010101010101010101010101010101010101010101
----------------------------------------------------------------------
硬件连接： 	  DVK501				     M128 EX+
				RST		---------	         PB4
				WP		---------	  		 PB5
				CS		---------	         PB0
				SI		---------	   		 PB2 
				SO		---------	   		 PB3
				SCK		---------	         PB1
				L0~L7	---------			 PORTA
----------------------------------------------------------------------
实验内容：
把256个数据写入dataflash缓存器1，再读出，使用PA口的LED做指示，观测是否与写入一致。
由于其命令较多，这里不作详细介绍，其它读写方式可参照本示例程序
---------------------------------------------------------------------
----------------------------------------------------------------------
注意事项： 
（1）若有加载库函数，请将光盘根目录下的“库函数”下的“ICC_H”文件夹拷到D盘
（2）请详细阅读“使用必读”及相关资料。
----------------------------------------------------------------------
10101010101010101010101010101010101010101010101010101010101010101010*/
#include <iom128v.h>
#include "D:\ICC_H\CmmICC.H"
#include "D:\ICC_H\AT45DB161.H"    

    
void port_init(void)
{
    PORTA = 0x00;
    DDRA  = 0xff;
    PORTB = 0xff;
    DDRB  = 0xbf;
    PORTC = 0x00;
    DDRC  = 0xff;
    PORTD = 0x00;
    DDRD  = 0xff;   
}

void main(void)
{	
	uint i;
	port_init();  
    spi_init();  

    //PORTB&=0xfb;      //PB2为低        rst
    PORTB&=0XEF;
    delay50ms(1); 
    //PORTB|=0x08;	    //PB3为高        wp
    PORTB|=(~0xDF);
                
    //PORTB|=0x04;     //  //PB2为高        rst	  
    PORTB|=(~0XEF);       
    for(i=0;i<256;i++)
    {  
        //PORTB&=0xef;	   //PB4为低      cs
        PORTB&=0XFE;
        write_buffer(i,i);	    //把256个数据写入dataflash缓存器 
    	  //PORTB|=0x10;        //  PB4为高     cs
    	  PORTB|=(~0XFE);
    }                                 
    delay50ms(2);                   
   	for(i=0;i<256;i++)           //从dataflash缓存器把256个数据读出
	{	
    	//PORTB&=0xef;	
    	PORTB&=0XFE;
			PORTA=read_buffer(i);		//通过PA口作显示      
      //PORTB|=0x10;	
      PORTB|=(~0XFE);
		  delay50ms(4);
	}    
    //PORTB&=0xf7;
    PORTB&=0xDF;
	while(1);
}