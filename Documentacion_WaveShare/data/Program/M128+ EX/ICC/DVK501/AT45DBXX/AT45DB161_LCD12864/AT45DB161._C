/*********************************************************************
	微 雪 电 子   WaveShare   http://www.waveShare.net            	
		                                                            
项目名称:   AT45DBXXX示例程序
		
目标系统:   “DVK501” && “M128+ EX”

应用软件:   ICCAVR 6.31A

版    本:   V1.0 

圆版时间:   2009-7-1

开发人员:   zz

说    明:   若用于商业用途，请保留此段文字或注明代码来源
		
	深 圳 市 微 雪 电 子 有 限 公 司 保 留 所 有 的 版 权     
*********************************************************************/

/*01010101010101010101010101010101010101010101010101010101010101010101
----------------------------------------------------------------------
版本更新记录：

----------------------------------------------------------------------
实验内容：
先将数据写入AT45DBXXX，然后再读数据并通过LED显示
----------------------------------------------------------------------
硬件连接： 	  DVK501				M128 EX+
				RST		---------	  PB4
				WP		---------	  B5
				CS		---------	  PB0
				SI		---------	  PB2 
				SO		---------	  PB3
				SCK		---------	  PB1
				L0~L7	---------	  PORTA
				CS		---------	  PB4
				PSB	    ---------	  GND
				SID		---------	  PB2
				CLK		---------	  PB1
----------------------------------------------------------------------
实验内容：
把256个数据写入dataflash缓存器1，再读出，使用PA口的LED做指示，观测是否与写入一致。
由于其命令较多，这里不作详细介绍，其它读写方式可参照本示例程序
---------------------------------------------------------------------
----------------------------------------------------------------------
注意事项： 
（1）若有加载库函数，请将光盘根目录下的“库函数”下的“ICC_H”文件夹拷到D盘
（2）请详细阅读“使用必读”及相关资料。
----------------------------------------------------------------------
10101010101010101010101010101010101010101010101010101010101010101010*/
硬件连接： 	  DVK500				 STK128+
				VCC		---------	  VCC
				GND		---------	  GND 	
				RST		---------	  PB4
				WP		---------	  PB5
				CS		---------	  PB0
				SI		---------	  PB2 
				SO		---------	  PB3
				SCK		---------	  PB1
				
		 	  DVK500				 STK128+
				CS		---------	  PA0
				PSB	    ---------	  GND
				SID		---------	  PB2
				CLK		---------	  PB1
----------------------------------------------------------------------
实验内容：
把256个数据写入dataflash缓存器1，再读出，使用LCD12864观测是否与写入一致。
由于其命令较多，这里不作详细介绍，其它读写方式可参照本示例程序
---------------------------------------------------------------------
----------------------------------------------------------------------
注意事项： 
（1）若有加载库函数，请将光盘根目录下的“库函数”下的“ICC_H”文件夹拷到D盘
（2）请详细阅读“使用必读”及相关资料。
----------------------------------------------------------------------
10101010101010101010101010101010101010101010101010101010101010101010*/
#include <iom128v.h>
#include <macros.h>
#include "D:\ICC_H\CmmICC.H"
#include "D:\ICC_H\LCD12864_ST7920_.H"
#include "D:\ICC_H\AT45DB161.H"

#define LCD_CLOSE cbi(PORTB,4)
#define LCD_OPEN sbi(PORTB,4)
void port_init(void)
{

    PORTB = 0xff;
    DDRB  = 0xbf;
    PORTC = 0x00;
    DDRC  = 0xff;
    PORTD = 0x00;
    DDRD  = 0xff;   
}

void main(void)
{	
	uint i;
	uchar tmp[256];
	
	port_init();  
    spi_init();  
    PORTB&=0XEF;
    delay50ms(1); 
    PORTB|=(~0xDF);
    PORTB|=(~0XEF);    
	LCD_CLOSE;  //关液晶
    for(i=0;i<256;i++)
    {  
        PORTB&=0XFE;
        write_buffer(i,i);	    //把256个数据写入dataflash缓存器 
    	PORTB|=(~0XFE);
    }                                 

	delay50ms(2);                   
   	for(i=0;i<256;i++)           //从dataflash缓存器把256个数据读出
	{	
    	PORTB&=0XFE;
		tmp[i]=read_buffer(i);		//寄存结果,供后面显示使用 
     	PORTB|=(~0XFE);
	    delay50us(1);
	   
	} 
    PORTB&=0xDF;
	
	LCD_OPEN; //开液晶
	lcd_init();
	lcd_clr();
	lcd_puts(1,1,"AT45DBX-LCD12864");
	lcd_puts(2,1,"FLASH   液晶显示");
	lcd_puts(3,1,"内容:");
	
	for(i=0;i<256;i++)
	{
	    lcd_putd(3,5,tmp[i],1);  //将刚刚从FLASH内读到的内容显示出来
		delay50ms(10); //延时0.5秒
	}
	
	while(1);
}