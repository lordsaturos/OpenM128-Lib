/*********************************************************************
    微 雪 电 子   WaveShare   http://www.waveShare.net            	
                                                                
目    的:   建立使用UART做自发自收的示例程序
    
目标系统:   基于AVR单片机
                                                                        
应用软件:   ICCAVR
                                                                        
版    本:   Version 1.0                                                          
                                                                        
圆版时间:   2005-06-25
    
开发人员:   SEE

说    明:   若用于商业用途，请保留此段文字或注明代码来源
    
    深 圳 市 微 雪 电 子 有 限 公 司 保 留 所 有 的 版 权     
*********************************************************************/

/*01010101010101010101010101010101010101010101010101010101010101010101
----------------------------------------------------------------------
版本更新记录：

----------------------------------------------------------------------
实验内容：
自发自收，使用PB口的LED指示接收到的数据，观察是否与发送的数据一致。
----------------------------------------------------------------------
硬件连接：  
将MCU.RXD与MCU.TXD使用短路帽短接，将PB口的LED指示灯使能开关切换到"ON"状态。
----------------------------------------------------------------------
注意事项：
（1）若有加载库函数，请将光盘根目录下的“库函数”下的“ICC_H”文件夹拷到D盘
（2）请详细阅读：光盘根目录下的“产品资料\开发板实验板\SMK系列\SMK1632\说明资料”
----------------------------------------------------------------------
10101010101010101010101010101010101010101010101010101010101010101010*/

#include <iom16v.h>
#include "D:\ICC_H\CmmICC.H"

#define DISP_PORT PORTB
#define DISP_DDR  DDRB

/*--------------------------------------------------------------------
函数名称：
函数功能：
注意事项：基于7.3728M晶振
提示说明：
输    入：
返    回：
--------------------------------------------------------------------*/
void uart0_init(void)
{
    UCSRB = 0x00;   //disable while setting baud rate
    UCSRA = 0x00;   //U2X = 0，不加倍数率
    UCSRC = 0x86;   //8位
    UBRRL = 47;     //set baud rate lo，波特率为9600
    UBRRH = 0x00;   //set baud rate hi
    UCSRB = 0x98;   //接收中断允许，接收缓冲自动清空，接收允许
}
/*--------------------------------------------------------------------
函数名称：
函数功能：
注意事项：
提示说明：
输    入：
返    回：
--------------------------------------------------------------------*/
#pragma interrupt_handler uart0_rx_isr:12
void uart0_rx_isr(void)
{
    DISP_PORT = UDR;//显示接收到的数据
//用串口调试助手发送数据,则单片机端显示数据对应的ASCII值,如:接收到"1",显示0X31
    //delay50ms(1);
}
/*--------------------------------------------------------------------
函数名称：
函数功能：
注意事项：
提示说明：
输    入：
返    回：
--------------------------------------------------------------------*/
void mcu_init(void)
{
    CLI(); 
    uart0_init();
    MCUCR = 0x00;
    GICR  = 0x00;
    TIMSK = 0x00;   //timer interrupt sources
    SEI();          //re-enable interrupts
}
/*--------------------------------------------------------------------
函数名称：
函数功能：
注意事项：
提示说明：
输    入：
返    回：
--------------------------------------------------------------------*/
void main()
{
    uint8 counter=0;

    mcu_init();

    DISP_DDR=0xFF;

    while(1)
    {
        UDR=counter++;			//发送数据，数据为变量counter
        while(!(UCSRA&0x40));	//等待发送结束
        UCSRA|=0x40;
        delay50ms(4);
    }
}
